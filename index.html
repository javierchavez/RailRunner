<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <title>Rail Runner</title>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>


    <style type="text/css">
        #holidayList { display: none; }
        #entire-sch { display: none; }
        /*body { background-color: #77171E}*/
        /*.container { }*/
        /*.title {color: #DC9125 }*/
        /*.title {color: #ffffff; background-color: #8C8C8E; padding-left: 3%; padding-top: 2%; padding-bottom: 2%;*/
            /*text-shadow: 2px 4px 3px rgba(0,0,0,0.3);*/
            /*-webkit-box-shadow: 0 4px 4px -2px #000000;*/
            /*-moz-box-shadow: 0 4px 4px -2px #000000;*/
            /*box-shadow: 0 4px 4px -2px #000000;}*/
        /*a{ color: #ffffff}*/
    /**/
        /*.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {*/
            /*background-color: #DC9125;*/
            /*border-color: #9F418F;*/

            /*yello #DC9125*/
            /*gray #8C8C8E*/
        /*}*/
        /*.btn-primary:hover, .btn-primary:focus, .btn-primary:active, .btn-primary.active, .open .dropdown-toggle.btn-primary {*/
            /*background-color: #DC9125;*/
            /*border-color: #31347B;*/
        /*}*/

        /*.btn*/
        /*{*/
            /*background-color: #DC9125;*/
            /*border-color: #9F418F;*/
        /*}*/
        /*.submit-btn { margin-top: 4%}*/
    </style>

</head>
<body>


    <div class="container">
        <div id="data-entry">


            <div class="row">
                <h3 class="title">Choose Direction</h3>
            </div>
            <div class="row">
                    <ul class="nav nav-pills nav-justified direction">
                        <li ><a href="#">Northbound</a></li>
                        <li><a href="#">Southbound</a></li>
                    </ul>
            </div>
            <div class="row">
                <h3 class="title">Choose Day</h3>
            </div>
            <div class="row">
                    <ul class="nav nav-pills nav-justified day">
                        <li ><a href="#">Weekday</a></li>
                        <li><a href="#">Saturday</a></li>
                        <li><a href="#">Sunday</a></li>
                        <li><a href="#" >Holiday</a></li>
                    </ul>
            </div>


            <div class="row">
                <select class="form-control" id="holidayList">
                    <option>Martin Luther King Jr. Day</option>
                    <option>Presidents' Day</option>
                    <option>Memorial Day</option>
                    <option>Independence Day</option>
                    <option>Labor Day Weekend</option>
                    <option>Columbus Day</option>
                    <option>Veterans Day</option>
                    <option>Thanksgiving Day</option>
                    <option>Day After Thanksgiving</option>
                    <option>Christmas Eve</option>
                    <option>Christmas Day</option>
                    <option>Day After Christmas</option>
                    <option>New Year's Eve</option>
                    <option>New Year's Day</option>
                    <option>Day After New Year's</option>
                </select>
            </div>

            <div id="user-data">

                <!--User Location selection-->
                <div class="row">
                        <h4 class="title" >Your Location:</h4>


                        <select class="form-control" id="from-stations">
                            <option>Choose direction first</option>
                        </select>

                </div>
                <!--Destination selection-->
                <div class="row">

                            <h4 class="title">Destination:</h4>



                            <select class="form-control" id="to-stations">
                                <option>Choose direction first</option>
                            </select>


                </div>
                <!--Time selection-->
                <div class="row">

                            <h4 class="title">Time of Departure:</h4>



                            <select class="form-control" id="d-time">
                                <option>Choose your location</option>
                            </select>


                </div>
            </div>
        </div>
        <div class="table-responsive" id="entire-sch">
            
            <table class="table table-bordered ">

                <thead>
                <tr>
                    <th>Time</th>
                    <th>Train</th>
                    <th>Station</th>
                </tr>
                </thead>

                <tbody id="schedule-table">
                <tr>
                    <td></td>
                    <td></td>
                    <td>row or cell</td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td>action</td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td>need attention</td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td>Indicates</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="row submit-btn">

                <button type="button"
                        data-toggle="modal"
                        id="show-sch-btn"
                        data-target="#myModal"
                        class="btn btn-primary btn-lg pull-right">Show Schedule</button>

        </div>
    </div>




    <script type="text/javascript">
        // Station data from server
        var sData;
        var stationsArr = [];   // station's names (string)
        var timesArr = [];      // train times (string)
        var position = {};       // speed up proc for getting data from ds
        var userLocation, userDestination;  // user set direction and day

        // Helper to find unique stations
        var unique = function(origArr) {
            var newArr = [],
                    origLen = origArr.length,
                    found,
                    x, y;

            for ( x = 0; x < origLen; x++ ) {
                found = undefined;
                for ( y = 0; y < newArr.length; y++ ) {
                    if ( origArr[x] === newArr[y] ) {
                        found = true;
                        break;
                    }
                }
                if ( !found) newArr.push( origArr[x] );
            }
            return newArr;
        };


        //call to get data from server with callback
        var ajax = {
            parseJSONP: function(result){
                sData = result;
            }
        };

        // get data from server and handle return
        $.ajax({
                    type       : "GET",
                    url        : "http://dev.appliciti.com/nmrx/config/work/json-all-schedules/",
                    dataType   : 'jsonp',
                    success    : function(response) {
                                    console.log("Data loaded successfully");
                                    ajax.parseJSONP(response);
                    },
                    error      : function() {
                        alert('Not working!');
                        console.log("Something went wrong trying to download data");
                    }
        });

        /*
        *
        * Highlight button based on user click
        * */
        var direction, day;
        $(document).ready(function () {
            $('ul.nav > li a').click(function (e) {
                // highlight option the user clicked
                $(this).closest('ul.nav').find('.active').removeClass('active');
                $(this).parent().addClass('active');

                // if the user clicked a Day option
                if($(this).text() == "Weekday"
                        || $(this).text() == "Saturday"
                        || $(this).text() == "Sunday"
                        || $(this).text() == "Holiday"){

                    //get the day that the user clicked
                    day = $(this).parent().text();

                    // if user clicked holiday then update DOM
                    if($(this).text() == "Holiday"){
                        $('#holidayList').css({"display":"inline"});
                    } else {
                        $('#holidayList').css({"display":"none"});
                    }
                }
                // the user clicked the direction
                else {
                    $('ul.day').find('.active').removeClass('active');
                    direction = $(this).parent().text();
                }

                // console.log("The user choose: DAY: " + day +" DIRECTION: " + direction)


                refresh(); //must be called first
                updateFormLocationData();
            });
        });

        // get the user location and destination from drop downs
        $('#to-stations').change(function () {
            userDestination = $(this).val();

            if(userDestination != "Select" || userDestination != "Choose your location"){
                position.endstation = $(this)[0].selectedIndex
            }

        });
        $('#from-stations').change(function () {
            //get the location of the user
            userLocation = $(this).val();
            // check to make sure its valid
            if(userLocation != "Select" && userLocation != "Choose your location"){
                // save the position of the option selected
                var d = $(this)[0].selectedIndex;

                // update the form
                refresh();
                updateFormTimeData();
                updateFormDestinationData(d);

            } else {
                // if not valid notify the user
                $('#d-time').html('<option>Choose your location</option>')
            }
        });

        $('#d-time').change(function () {
            // to accommodate for "Select" in options menu -1
            position.time = $(this)[0].selectedIndex - 1;
            position.trainName = sData[position.station]["data"][position.time]["train"];
            console.log(position.trainName)
            //console.log(position.time)

        });


        $('#show-sch-btn').click( function () {
            // if on schedule change to trip
            if ($(this).text() == "Show Schedule"){
                var sch = []
                // beginning
                var b = sData[position.station]["data"];

                console.log(position.time)

                for (var x = position.time; x < sData[position.station]["data"].length; x++) {
                    if(b[x]["train"] == position.trainName){
                        sch.push(sData[position.station]["data"][x])
                        console.log("found train "+b[x]["train"])
                        if(b[x]["station"] == userDestination){

                            break;
                        }
                    }

                }
                var schl = "";
                for (var c =0; c < sch.length; c++){
                    schl += '<tr>' +
                            '<td>'+ sch[c]["time"] +'</td>' +
                            '<td>'+ sch[c]["train"] +'</td>' +
                            '<td>'+ sch[c]["station"] +'</td></tr>';
                }


                document.getElementById("schedule-table").innerHTML = "";
                document.getElementById("schedule-table").innerHTML = schl;


                //change the text on the button
                $(this).text("Change Trip");

                // adjust views
                $("#data-entry").fadeOut();
                $("#entire-sch").fadeIn();

            }
            // if on trip change to schedule
            else {
                // set the text of the button
                $(this).text("Show Schedule");

                // adjust views
                $("#data-entry").fadeIn();
                $("#entire-sch").fadeOut();


            }
        });


        function refresh(){
            if(sData != null){
                // clear current array
                stationsArr = [];
                timesArr = [];
                //sort through data
                for (var i =0; i < sData.length;i++){
                    //add check for holiday(holidays)
                    // find what data to use from data set
                    if((sData[i]["name"].indexOf(direction) != -1) && (sData[i]["name"].indexOf(day) != -1)){
                        // console.log(sData[i]["name"])
                        // get stations names
                        position.station = i;
                        for (var x = 0; x < sData[i]["data"].length; x++){
                            stationsArr.push(sData[i]["data"][x]["station"]);
                            if (userLocation == sData[i]["data"][x]["station"]){
                                timesArr.push(sData[i]["data"][x]["time"]);
                            }
                        }
                    }
                }
            }
        }

        function updateFormLocationData(){

            // get unique stations
            var uniqStationsArr = unique(stationsArr);
            // console.log(uniqStationsArr.length)

            /*
            *
            * Set FROM options
            *
            * */
            var stringFrom = '<option>Select</option>';
            for (var s = 0; s < uniqStationsArr.length; s++){
                stringFrom += '<option>'+ uniqStationsArr[s] +'</option>';
            }
            document.getElementById("from-stations").innerHTML = "";
            document.getElementById("from-stations").innerHTML = stringFrom;
        }

        function updateFormDestinationData (from){
            // get unique stations
            var uniqStationsArr = unique(stationsArr);
            // console.log(uniqStationsArr.length)

            /*
             *
             * Set TO options
             *
             *
             * */
            var stringTo = '<option>Select</option>';
            // from is the option selected
            // since we dont want to include options prior we start from what the user selected
            for (var s = from; s < uniqStationsArr.length; s++){
                stringTo += '<option>'+ uniqStationsArr[s] +'</option>';
            }
            document.getElementById("to-stations").innerHTML = "";
            document.getElementById("to-stations").innerHTML = stringTo;

        }

        function updateFormTimeData() {
            /*
             *
             * Set TIME options
             *
             * */
            var stringTimes = '<option>Select</option>';
            for (var s = 0; s < timesArr.length; s++){
                stringTimes += '<option>'+ timesArr[s] +'</option>';
            }
            document.getElementById("d-time").innerHTML = "";
            document.getElementById("d-time").innerHTML = stringTimes;
        }

    </script>

</body>
</html>