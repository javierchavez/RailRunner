<!DOCTYPE html>
<html>
<head>
    <title>Rail Runner</title>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>


    <style type="text/css">
        #holidayList { display: none; }
    </style>

</head>
<body>


    <div class="container">

        <div class="row">
            <h3>Choose Direction</h3>
        </div>
        <div class="row">
                <ul class="nav nav-pills nav-justified direction">
                    <li ><a href="#">Northbound</a></li>
                    <li><a href="#">Southbound</a></li>
                </ul>
        </div>
        <div class="row">
            <h3>Choose Day</h3>
        </div>
        <div class="row">
                <ul class="nav nav-pills nav-justified day">
                    <li ><a href="#">Weekday</a></li>
                    <li><a href="#">Saturday</a></li>
                    <li><a href="#">Sunday</a></li>
                    <li><a href="#" >Holiday</a></li>
                </ul>
        </div>


        <div class="row">
            <select class="form-control" id="holidayList">
                <option>Martin Luther King Jr. Day</option>
                <option>Presidents' Day</option>
                <option>Memorial Day</option>
                <option>Independence Day</option>
                <option>Labor Day Weekend</option>
                <option>Columbus Day</option>
                <option>Veterans Day</option>
                <option>Thanksgiving Day</option>
                <option>Day After Thanksgiving</option>
                <option>Christmas Eve</option>
                <option>Christmas Day</option>
                <option>Day After Christmas</option>
                <option>New Year's Eve</option>
                <option>New Year's Day</option>
                <option>Day After New Year's</option>
            </select>
        </div>

        <div id="user-data">

            <!--User Location selection-->
            <div class="row">
                <div class="row">
                    <div class="col-md-4">
                        <h4>Your Location:</h4>
                    </div>
                    <div class="col-md-4">
                        <select class="form-control" id="from-stations">
                            <option>Choose direction first</option>
                        </select>
                    </div>
                </div>
            </div>
            <!--Destination selection-->
            <div class="row">
                <div class="row">
                    <div class="col-md-4">
                        <h4>Destination:</h4>
                    </div>
                    <div class="col-md-4">
                        <select class="form-control" id="to-stations">
                            <option>Choose direction first</option>
                        </select>
                    </div>
                </div>
            </div>
            <!--Time selection-->
            <div class="row">
                <div class="row">
                    <div class="col-md-4">
                        <h4>Time of Departure:</h4>
                    </div>
                    <div class="col-md-4">
                        <select class="form-control" id="d-time">
                            <option>Choose your location</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <p>
                <button type="button" id="view-toggle-btn" class="btn btn-primary btn-lg pull-right">Show Schedule</button>
            </p>
        </div>
    </div>


    <script type="text/javascript">
        // Station data from server
        var sData;
        var stationsArr = [];   // station's names (string)
        var timesArr = []       // train times (string)
        var userLocation, userDestination;  // user set direction and day

        // Helper to find unique stations
        var unique = function(origArr) {
            var newArr = [],
                    origLen = origArr.length,
                    found,
                    x, y;

            for ( x = 0; x < origLen; x++ ) {
                found = undefined;
                for ( y = 0; y < newArr.length; y++ ) {
                    if ( origArr[x] === newArr[y] ) {
                        found = true;
                        break;
                    }
                }
                if ( !found) newArr.push( origArr[x] );
            }
            return newArr;
        };


        //call to get data from server with callback
        var ajax = {
            parseJSONP: function(result){
                sData = result;
            }
        }

        // get data from server and handle return
        $.ajax(
                {
                    type       : "GET",
                    url        : "http://dev.appliciti.com/nmrx/config/work/json-all-schedules/",
                    dataType   : 'jsonp',
                    success    : function(response) {
                        console.log("Data loaded successfully")
                        ajax.parseJSONP(response);
                    },
                    error      : function() {
                        alert('Not working!');
                        console.log("Something went wrong trying to download data")
                    }

                }
        );

        /*
        *
        * Highlight button based on user click
        * */
        var direction, day;
        $(document).ready(function () {
            $('ul.nav > li a').click(function (e) {
                // highlight option the user clicked
                $(this).closest('ul.nav').find('.active').removeClass('active');
                $(this).parent().addClass('active');

                // if the user clicked a Day option
                if($(this).text() == "Weekday" || $(this).text() == "Saturday" || $(this).text() == "Sunday" || $(this).text() == "Holiday"){
                    //get the day that the user clicked
                    day = $(this).parent().text();

                    // if user clicked holiday then update DOM
                    if($(this).text() == "Holiday"){
                        $('#holidayList').css({"display":"inline"})
                    } else {
                        $('#holidayList').css({"display":"none"})
                    }
                }
                // the user clicked the direction
                else {
                    $('ul.day').find('.active').removeClass('active');
                    direction = $(this).parent().text();
                }

                // console.log("The user choose: DAY: " + day +" DIRECTION: " + direction)


                refresh(); //must be called first
                updateFormLocationData();
            });
        });

        // get the user location and destination from drop downs
        $('#to-stations').change(function () {
            userDestination = $(this).val();
        });
        $('#from-stations').change(function () {
            //get the location of the user
            userLocation = $(this).val();
            // check to make sure its valid
            if(userLocation != "Select" && userLocation != "Choose your location"){
                // update the form
                updateFormTimeData();
            } else {
                // if not valid notify the user
                $('#d-time').html('<option>Choose your location</option>')
            }
        })


        function refresh(){
            if(sData != null){
                // clear current array
                stationsArr = []
                //sort through data
                for (var i =0; i < sData.length;i++){
                    //add check for holiday(holidays)
                    // find what data to use from data set
                    if((sData[i]["name"].indexOf(direction) != -1) && (sData[i]["name"].indexOf(day) != -1)){
                        // console.log(sData[i]["name"])
                        // get stations names
                        for (var x = 0; x < sData[i]["data"].length; x++){
                            stationsArr.push(sData[i]["data"][x]["station"])
                            if (userLocation == sData[i]["data"][x]["station"]){
                                timesArr.push(sData[i]["data"][x]["time"])
                            }
                        }
                    }
                }
            }
        }

        function updateFormLocationData(){

            // get unique stations
            var uniqStationsArr = unique(stationsArr)
            console.log(uniqStationsArr.length)

            /*
            *
            * Set TO options
            *
            * */
            var stringTo = '<option>Select</option>'
            for (var s = 0; s < uniqStationsArr.length; s++){
                stringTo += '<option>'+ uniqStationsArr[s] +'</option>';
            }
            document.getElementById("to-stations").innerHTML = ""
            document.getElementById("to-stations").innerHTML = stringTo

            /*
            *
            * Set FROM options
            *
            * */
            var stringFrom = '<option>Select</option>'
            for (var s = 0; s < uniqStationsArr.length; s++){
                stringFrom += '<option>'+ uniqStationsArr[s] +'</option>';
            }
            document.getElementById("from-stations").innerHTML = ""
            document.getElementById("from-stations").innerHTML = stringFrom

        }

        function updateFormTimeData() {
            /*
             *
             * Set TIME options
             *
             * */
            var stringTimes = ""
            for (var s = 0; s < timesArr.length; s++){
                stringTimes += '<option>'+ timesArr[s] +'</option>';
            }
            document.getElementById("d-time").innerHTML = ""
            document.getElementById("d-time").innerHTML = stringTimes
        }

        /*
        *
        * Toggle between schedule view and settings view
        *
        * */
        var scheduleState, dataState = ""
        $("#view-toggle-btn").click(function(){

            // if on schedule change to trip
           if ($(this).text() == "Show Schedule"){
               //change the text on the button
               $(this).text("Change Trip")
               //save the schedule html
               scheduleState = $("#user-data").html();
               //set the data area to
               $("#user-data").html(dataState);
           }
           // if on trip change to schedule
           else {
               // set the text of the button
               $(this).text("Show Schedule")
               // save the current data
               dataState = $("#user-data").html();
               //set the data area to
               $("#user-data").html(scheduleState);
           }
        });



    </script>

</body>
</html>