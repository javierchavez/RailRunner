<!DOCTYPE HTML>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <title>Rail Runner</title>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <!--<script src="https://code.jquery.com/jquery.js"></script>-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="css/bootstrap.css">
    <!-- Latest compiled and minified JavaScript -->
    <!--<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>-->

    <script src="js/spinningwheel.js"></script>
    <link rel="stylesheet" href="css/spinningwheel.css">

    <style type="text/css">




        /*#holidayList { display: none; }*/
        #data-entry, #trips-btn { display: none; }
        @-webkit-keyframes blink {
            from { opacity: 1.0; }
            to { opacity: 0.0; }
        }

        #trip-row {
            /*background-color: lightgrey;*/
            padding: 2% 4%;
        }

        #fare {
            color: #DC9125;
        }

        .blink {
            -webkit-animation-name: blink;
            -webkit-animation-iteration-count: infinite;
            -webkit-animation-timing-function: cubic-bezier(1.0,0,0,1.0);
            -webkit-animation-duration: 2s;
        }
        /*@media(max-width:767px){*/

            /*.title, .info-all {padding-left: 3%; }*/
            /*#quite-c {padding-right: 3%; color: #DC9125; }*/
            /*.submit-btn { padding-right: 3%; padding-bottom: 3%}*/
            /*.day, .direction {*/
                /*padding-right: 3%;*/
            /*}*/
            /*.pull-right {*/
                /*float: right!important;*/
            /*}*/
        /*}*/
        /*@media(min-width:768px){*/
            /*.pull-right {*/
                /*float: left!important;*/
            /*}*/

        /*}*/

        /*.info-all { float: right!important;}*/
        /*#quite-c {color: #DC9125; float: right!important;}*/


        /*a{ color: #DC9125 }*/


        /*h4{ color: #DC9125 }*/

        /*.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {*/
            /*background-color: #ffffff;*/
            /*border-color: #DC9125;*/

            /*border-radius: 6px;*/
            /*border: solid 1px #DC9125;*/

            /*yello #DC9125*/
            /*gray #8C8C8E*/
        /*}*/
        /*.btn-primary:hover, .btn-primary:focus, .btn-primary:active, .btn-primary.active, .open .dropdown-toggle.btn-primary {*/
            /*color: #77171E;*/
            /*background-color: #ffffff;*/
            /*border-color: #DC9125;*/
        /*}*/

        /*.nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {*/
            /*color: #DC9125*/
        /*}*/

        /*.btn, .btn-primary*/
        /*{*/
            /*color: #77171E;*/
            /*background-color: #ffffff;*/
            /*border-color: #DC9125;*/
        /*}*/
        /*.submit-btn { margin-top: 4%}*/

        /*li > a:hover {*/
            /*color: black;*/
        /*}*/
    </style>



</head>
<body>



    <div class="container">
        <button type="button" class="btn btn-default" id="change-trp-btn" onclick="swExample()">Change Trip</button>
        <button type="button" class="btn btn-default" id="set-dir-btn" onclick="setDir()"><span class="glyphicon glyphicon-sort" id="dir"> N</span></button>

        <div id="data-entry">
            <div class="row" id="trip-row">
                <button type="button" class="btn btn-default pull-left" id="trips-btn" onclick="showTrips()"><span class="glyphicon glyphicon-arrow-left"> Change</span></button>
                <div class="row pull-right">
                    <div class="col-md-1" id="depart-time">.col-md-4</div>
                    <div class="col-md-1" id="arrive-time">.col-md-4</div>
                </div>

                <!--<div class="col-md-4" id="duration"></div>-->

            </div>
            <div class="row">
                <div class="col-md-4" id="depart">.col-md-4</div>
                <div class="col-md-4" id="arrive">.col-md-4</div>
                <div class="col-md-4 pull-right" id="fare"></div>

            </div>
            <table id="detail-schedule" class="table">


                <tbody id="detail-table">

                </tbody>
            </table>
        </div>

        <div id="entire-sch">
            <!--class="table-responsive"-->
            <div class="row">
                <!--<h4 class="title">Your schedule</h4>-->
                <p id="quite-c"></p>
            </div>
            <table id="schedule" class="table table-striped">


                <tbody id="schedule-table">

                </tbody>
            </table>
        </div>

    </div>


    <script type="text/javascript">



        // Station data from server
        var sData;
        var trainNum;
        var directionArray = [];
        var allTrips = [];
        var selected;
        var direction = "Northbound";


        // Helper to find unique stations
        var unique = function(origArr) {
            var newArr = [],
                    origLen = origArr.length,
                    found,
                    x, y;

            for ( x = 0; x < origLen; x++ ) {
                found = undefined;
                for ( y = 0; y < newArr.length; y++ ) {
                    if ( origArr[x] === newArr[y] ) {
                        found = true;
                        break;
                    }
                }
                if ( !found) newArr.push( origArr[x] );
            }
            return newArr;
        };
        // Helper to remove a given elem from array
        Array.prototype.removeByIndex = function(index) {
            this.splice(index, 1);
        };
        // Helper to get the current day with respect to train sch.
        getDay = function(){
            var d=new Date();
            var weekday = new Array(7);
            weekday[0]="Sunday";
            weekday[1]="Weekday";
            weekday[2]="Weekday";
            weekday[3]="Weekday";
            weekday[4]="Weekday";
            weekday[5]="Weekday";
            weekday[6]="Saturday";

            return weekday[d.getDay()];
        }
        calcPrice = function(duration, from, destination){
            //var from = $("#stationListFrom").val();
            //var destination =  $("#stationListTo").val();
            var zoneFrom = 0;
            var zoneTo = 0;

            from = from.substr(3);
            destination = destination.substr(3);

            switch (from) {
                case 'Santa Fe Depot':
                case 'South Capitol':
                case 'Zia Road':
                    zoneFrom = 1;
                    break;
                case 'SF County / NM 599':
                    zoneFrom = 2;
                    break;
                case 'Kewa':
                    zoneFrom = 3;
                    break;
                case 'Sandoval/ US 550':
                case 'Downtown Bernalillo':
                    zoneFrom = 4;
                    break;
                case 'Sandia Pueblo':
                case 'Los Ranchos / JC':
                case 'Downtown ABQ':
                case 'Bernalillo County':
                case 'Isleta Pueblo':
                    zoneFrom = 5;
                    break;
                case 'Los Lunas':
                case 'Belen':
                    zoneFrom = 6;
                    break;
            }

            switch (destination) {
                case 'Santa Fe Depot':
                case 'South Capitol':
                case 'Zia Road':
                    zoneTo = 1;
                    break;
                case 'SF County / NM 599':
                    zoneTo = 2;
                    break;
                case 'Kewa':
                    zoneTo = 3;
                    break;
                case 'Sandoval/ US 550':
                case 'Downtown Bernalillo':
                    zoneTo = 4;
                    break;
                case 'Sandia Pueblo':
                case 'Los Ranchos / JC':
                case 'Downtown ABQ':
                case 'Bernalillo County':
                case 'Isleta Pueblo':
                    zoneTo = 5;
                    break;
                case 'Los Lunas':
                case 'Belen':
                    zoneTo = 6;
                    break;
            }

            var zones = Math.abs(zoneFrom - zoneTo) + 1;
            //var duration = $('input[name=radio-duration]:checked').val();
            var type = 'Regular';
            var price = '$';
            var discountPrice = '$';

            switch(zones) {
                case 1:
                    if (duration == 'One-Trip') {
                        discountPrice = '1';
                        price = '1';}
                    else if (duration == 'Day') {
                        discountPrice = '2';
                        price = '3';}
                    else if (duration == 'Month') {
                        discountPrice = '19';
                        price = '39';}
                    else if (duration == 'Annual') {
                        discountPrice = '187';
                        price = '385';}
                    break;
                case 2:
                    if (duration == 'One-Trip') {
                        discountPrice = '1';
                        price = '3';}
                    else if (duration == 'Day') {
                        discountPrice = '2';
                        price = '4';}
                    else if (duration == 'month') {
                        discountPrice = '28';
                        price = '55';}
                    else if (duration == 'annual') {
                        discountPrice = '275';
                        price = '550';}
                    break;
                case 3:
                    if (duration == 'One-Trip') {
                        discountPrice = '2';
                        price = '5';}
                    else if (duration == 'Day') {
                        discountPrice = '3';
                        price = '6';}
                    else if (duration == 'Month') {
                        discountPrice = '36';
                        price = '72';}
                    else if (duration == 'Annual') {
                        discountPrice = '352';
                        price = '715';}
                    break;
                case 4:
                    if (duration == 'One-Trip') {
                        discountPrice = '4';
                        price = '8';}
                    else if (duration == 'Day') {
                        discountPrice = '6';
                        price = '9';}
                    else if (duration == 'Month') {
                        discountPrice = '52';
                        price = '105';}
                    else if (duration == 'Annual') {
                        discountPrice = '517';
                        price = '1045';}
                    break;
                case 5:
                    if (duration == 'One-Trip') {
                        discountPrice = '4';
                        price = '9';}
                    else if (duration == 'Day') {
                        discountPrice = '7';
                        price = '10';}
                    else if (duration == 'Month') {
                        discountPrice = '55';
                        price = '110';}
                    else if (duration == 'Annual') {
                        discountPrice = '550';
                        price = '1100';}
                    break;
                case 6:
                    if (duration == 'One-Trip') {
                        discountPrice = '5';
                        price = '10';}
                    else if (duration == 'Day') {
                        discountPrice = '8';
                        price = '11';}
                    else if (duration == 'Month') {
                        discountPrice = '121';
                        price = '61';}
                    else if (duration == 'Annual') {
                        discountPrice = '605';
                        price = '1210';}
                    break;
            }

            //$('#price').text(price);
            //$('#discountPrice').text(discountPrice);


            if(duration == 'Month'){
                price = Number(parseFloat(price) / 30.0).toFixed(2);
                discountPrice = Number(parseFloat(discountPrice) / 30.0).toFixed(2);
            }
            else if(duration == 'Annual'){
                price = Number(parseFloat(price) / 365.0).toFixed(2);
                discountPrice = Number(parseFloat(discountPrice) / 365.0).toFixed(2);
            }

            var foo =[];
            foo.push(price);
            foo.push(discountPrice);

            return [price, discountPrice]
        }

        //call to get data from server with callback
        var ajax = {
            parseJSONP: function(result){
                sData = result;

                var day = getDay();

                setDirectionArray(direction, day);
                swExample();
                return false;
            }
        };

        // get data from server and handle return
        $.ajax({
                    type       : "GET",
                    url        : "http://dev.appliciti.com/nmrx/config/work/json-all-schedules/",
                    dataType   : 'jsonp',
                    success    : function(response) {
                                    console.log("Data loaded successfully");
                                    ajax.parseJSONP(response);
                    },
                    error      : function() {
                        alert('Not working!');
                        console.log("Something went wrong trying to download data");
                    }
        });

        /*
        *
        * Get the row the user clicked
        * */
        $(document).ready(function () {
            $('#schedule').on('click', 'tr', function() {

                var id = $(this).attr('id');

                // adjust views
                $("#change-trp-btn").fadeOut();
                $("#set-dir-btn").fadeOut();
                $("#entire-sch").fadeOut();
                $("#data-entry").delay(500).fadeIn();
                $("#trips-btn").fadeIn();
                detailedSch(parseInt(id));

                return false;
            });
        });



        /*
        $('#from-stations').change(function () {
            //get the location of the user
            var userLocation = $(this).val();
            // check to make sure its valid
            if(userLocation != "Select" && userLocation != "Choose your location"){
                // save the position of the option selected
                var d = $(this)[0].selectedIndex;


                updateTimeSelector(userLocation);

            } else {
                // if not valid notify the user
                $('#d-time').html('<option>Choose your location</option>')
            }
        });

        $('#d-time').change(function(){
            // var index = $('#from-stations')[0].selectedIndex;
            var d = $('#from-stations').val();
            var t = $(this).val();
            updateUserDestSelector (d, t);
        });
        */

        /*
        $('#show-sch-btn').click( function () {

            // if on schedule change to trip
            if ($(this).text() == "Show Schedule"){
                var sch = [];
                var userLoc = $('#from-stations').val();
                var userDes = $('#to-stations').val();
                var userTime = $('#d-time').val();


                //using the train number get the object
                for(var x =0; x < directionArray.length; x++){
                    if(directionArray[x]["train"] == trainNum){
                        sch.push(directionArray[x])
                    }
                }

                // remove trailing elements while its ont
                for(var i = sch.length - 1; i >= 0; i--) {
                    if(sch[i]["station"] != userDes) {
                        sch.removeByIndex(i);
                    } else if (sch[i]["station"] == userDes){
                        break;
                    }

                }

                // removing zero element while not the user's location
                while(sch[0]["station"] != userLoc){
                    sch.removeByIndex(0);
                }

                var t1 = new Date();
                var t2 = new Date();

                // setting time
                var pt = sch[sch.length-1]["time"].match(/(\d+)(?::(\d\d))?\s*(p?)/);
                t1.setHours( parseInt(pt[1]) + (pt[3] ? 12 : 0) );
                t1.setMinutes( parseInt(pt[2]) || 0 );

                // setting time time 2
                var pt2 = sch[0]["time"].match(/(\d+)(?::(\d\d))?\s*(p?)/);
                t2.setHours( parseInt(pt2[1]) + (pt2[3] ? 12 : 0) );
                t2.setMinutes( parseInt(pt2[2]) || 0 );

                // estimate time
                var ms = t1 - t2;
                x = ms / 1000;
                // var seconds = x % 60;
                x /= 60;
                // var minutes = x % 60;
                x /= 60;
                var hours = x % 24;

                // truncate decimal
                var trunHours = Math.floor(hours * 10) / 10;
                // DEBUG
                // console.log( hours );

                var schl = "";
                for (var c =0; c < sch.length; c++){
                    var busAvil = (sch[c]["rtd"]=="1")?'<span class="glyphicon glyphicon-ok-sign"></span>':'';
                    var lastTrain = (sch[c]["final"]=="1")?'<span class="glyphicon glyphicon-remove-circle"></span>':'';
                    schl += '<tr>' +
                                '<td>'+ sch[c]["time"] +'</td>' +
                                '<td>'+ sch[c]["train"] +'</td>' +
                                '<td>'+ sch[c]["station"] + " " + busAvil + " " + lastTrain +'</td>'+
                            '</tr>';
                }
                // these are the trains that have quiet cars
                if(sch[0]["train"] == "502" || sch[0]["train"] == "504" ||
                        sch[0]["train"] == "102_exp" || sch[0]["train"] == "506" ||
                        sch[0]["train"] == "512" || sch[0]["train"] == "514" ||
                        sch[0]["train"] == "503" || sch[0]["train"] == "507" ||
                        sch[0]["train"] == "509" || sch[0]["train"] == "515" ||
                        sch[0]["train"] == "101_exp" || sch[0]["train"] == "517" ||
                        sch[0]["train"] == "519"){
                    // show user
                    $("#quite-c").text("Designated QUIET CAR available");
                }

                // display schedule to user
                document.getElementById("schedule-table").innerHTML = schl;
                // total time
                $("#sch-info").text("Total Time (est.): " + trunHours + "hours");



                // adjust views
                $(this).fadeOut();
                $(this).text("Change Trip");
                $("#data-entry").fadeOut();
                $("#entire-sch").delay(500).fadeIn();
                $(this).delay(100).fadeIn();

            }
            // if on trip change to schedule
            else {
                // set the text of the button

                // adjust views
                $("#entire-sch").fadeOut();
                $(this).fadeOut();
                $("#data-entry").delay(500).fadeIn();
                $(this).text("Show Schedule");
                $(this).delay(100).fadeIn();


            }
        });
        */

        // this sets an array that holds all the object associated with direction "Northbound Weekday"
        function setDirectionArray(dir, day){

            var dirday = dir + " " + day;

            for(var x =0; x < sData.length; x++){
                if (sData[x]["name"] == dirday){
                    directionArray  = sData[x]["data"]
                }
            }
        }

        function updateFrom(){

            var stations = []
            //getting all the unique station names
            for(var x =0; x < directionArray.length; x++){
                if(stations.indexOf(directionArray[x]["station"]) == -1){
                    stations.push(directionArray[x])
                }
            }

            return stations;

         }

        function updateTo (id, time, userDes){
            // get unique stations
            var stops = [];

            // find the train number associated with time and location
            for(var x =0; x < directionArray.length; x++){
                if(directionArray[x]["id"] == id && directionArray[x]["time"] == time){
                    trainNum =  directionArray[x]["train"];
                    break;
                }
            }

            // get all the stops of that train
            for(var x =0; x < directionArray.length; x++){
                //console.log(directionArray[x]["train"] );
                if(directionArray[x]["train"].indexOf(trainNum) > -1){
                    stops.push(directionArray[x]);
                }
            }


//            removing zero element while not the user's location
            while(stops[0]["id"] != id){
                stops.removeByIndex(0);
            }
            // also remove the object that is the same as the user location
//            stops.removeByIndex(0);


            // remove trailing elements while its ont
            for(var i = stops.length - 1; i >= 0; i--) {
                if(stops[i]["station"] != userDes) {
                    stops.removeByIndex(i);
                } else if (stops[i]["station"] == userDes){
                    break;
                }

            }
            if(stops.length > 0){
                return stops;
            } else{
                return "Train arrives but does not continue";
            }
         }


        function updateTimeSelector(arr) {

            // getting the key of the first spinner to get users location
            var id = parseInt(arr.keys[0]);
            var destid = arr.keys[1];

            //console.log(id + " " + destid)

            var destinationStation = arr.values[1];


            destinationStation = (destid.length <= 1)?'0'+destid+" "+destinationStation:destid+" "+destinationStation;

            // get times from given station
            var times = [];
            //getting all the unique station names
            for(var x =0; x < directionArray.length; x++){
                if(directionArray[x]["id"] == id){
                    times.push(directionArray[x])
                }
            }

            allTrips = [];

            for(var c=0; c < times.length; c++){
                var t = updateTo(id,times[c]["time"],destinationStation)
                allTrips.push(t)
            }


            var schl = "";


            for (var c =0; c < times.length; c++){



                if (allTrips[c][allTrips[c].length-1].hasOwnProperty("time") && allTrips[c][0].hasOwnProperty("time")){
                    var t1 = new Date();
                    var t2 = new Date();

                    // setting time
                    var pt = allTrips[c][allTrips[c].length-1]["time"].match(/(\d+)(?::(\d\d))?\s*(p?)/i);
                    t1.setHours( parseInt(pt[1]) + (pt[3] ? 12 : 0) );
                    t1.setMinutes( parseInt(pt[2]) || 0 );

                    // setting time time 2
                    var pt2 = times[c]["time"].match(/(\d+)(?::(\d\d))?\s*(p?)/i);
                    t2.setHours( parseInt(pt2[1]) + (pt2[3] ? 12 : 0) );
                    t2.setMinutes( parseInt(pt2[2]) || 0 );

                    // estimate time
                    var ms = t1 - t2;
                    x = ms / 1000;
                    // var seconds = x % 60;
                    x /= 60;
                    var minutes = x % 60;
                    x /= 60;
                    var hours = x % 24;

                    // truncate decimal
                    var truncated = Math.floor(hours * 10) / 10;
                    var time = 0;
                    if(truncated >= 1){
                        time = (Math.floor(hours * 10) / 10).toString() + " hours";
                    } else {
                        time = (Math.floor(minutes * 10) / 10).toString() + " minuets";
                    }
                    // var busAvil = (times[c]["rtd"]=="1")?'<span class="glyphicon glyphicon-ok-sign"></span>':'';
                    // var lastTrain = (times[c]["final"]=="1")?'<span class="glyphicon glyphicon-remove-circle"></span>':'';

                    //check the time to see if its with in the 30min threshold
                    var bli = (checkTime(t2))?' class="blink" ':'';
                    var ct = new Date(), // current time
                            hours = ct.getHours(),
                            mins = ct.getMinutes();

                    if(ct < t2){

                        schl += '<tr id="'+c+'" '+ bli +'>' +
                                '<td>'+ "#"+times[c]["train"].replace(/_/g, ' ') +'</td>' +
                                '<td>'+ times[c]["time"] + " - " + allTrips[c][allTrips[c].length-1]["time"]+'</td>' +
                                '<td>'+ time + '</td>'+
                                '</tr>';
                    }
                }
            }

            // display schedule to user
            document.getElementById("schedule-table").innerHTML = schl
            return false;
        }

        function detailedSch(id){
            // getting trip from array (2d)
            var trip = allTrips[id];

            // setting data to UI
            $('#depart').text("Depart: " + trip[0]["station"].substr(3));
            $('#arrive').text("Arrive: " +trip[trip.length-1]["station"].substr(3));
            $('#depart-time').text("Departing at: " +trip[0]["time"]);
            $('#arrive-time').text("Arriving at: " +trip[trip.length-1]["time"]);

            // Calculating price of trip
            var price = calcPrice("One-Trip", trip[0]["station"], allTrips[parseInt(id)][allTrips[parseInt(id)].length-1]["station"])

            // setting the price to UI
            $('#fare').text("$"+price[0]);

            // console.log(trip)

            var schl = "";
            for(var x = 0; x < trip.length; x++){
                schl += '<tr>' +
                        '<td>'+ "#"+trip[x]["train"].replace(/_/g, ' ') +'</td>' +
                        '<td>'+ trip[x]["time"] +'</td>' +
                        '</tr>';

            }
            document.getElementById("detail-table").innerHTML = schl;
            return false;

        }

        function checkTime(time) {
            var d = new Date(), // current time
                    hours = d.getHours(),
                    mins = d.getMinutes();
            // adding 30min to current time
            d.setMinutes(d.getMinutes() +30);
            //console.log(d + " " + time)
            // if the hours match and the mins of the arg give are less then current time
            return d.getHours() == time.getHours() && time.getMinutes() < d.getMinutes();
        }

        function swExample() {

            var fromArr = updateFrom();
            var left = {};

            for (var i=0; i < fromArr.length; i++){
                left[fromArr[i]["id"]] = fromArr[i]["station"].substr(3);
            }

            SpinningWheel.addSlot(left, 'left');
            SpinningWheel.addSlot(left, 'right', 2);
            SpinningWheel.setCancelAction(cancel);
            SpinningWheel.setDoneAction(done);

            SpinningWheel.open();
            return false;

        }


        function done() {
            var results = SpinningWheel.getSelectedValues();
            selected = results;
            //console.log(results)
            updateTimeSelector(results);
        }

        function cancel() {
            setDir();
        }

        function setDir(){
            //SpinningWheel.destroy();
            if(direction == "Northbound"){
                direction = "Southbound";
                $("#dir").text(" S")
            } else {
                direction = "Northbound";
                $("#dir").text(" N")
            }
            var day = getDay();

            setDirectionArray(direction, day);
//            swExample();
            return false;
        }

        function showTrips() {
            // adjust views
            $("#trips-btn").fadeOut();
            $("#data-entry").fadeOut();
            $("#entire-sch").delay(500).fadeIn();
            $("#set-dir-btn").fadeIn();
            $("#change-trp-btn").fadeIn();
            return false;
        }


    </script>

</body>
</html>