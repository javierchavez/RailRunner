<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <title>Rail Runner</title>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>

    <script src="js/spinningwheel-min.js"></script>

    <link rel="stylesheet" href="js/spinningwheel.css">


    <style type="text/css">

        /*#holidayList { display: none; }*/
        #entire-sch { display: none; }
        @media(max-width:767px){

            .title, .info-all {padding-left: 3%; }
            #quite-c {padding-right: 3%; color: #DC9125; }
            .submit-btn { padding-right: 3%; padding-bottom: 3%}
            .day, .direction {
                padding-right: 3%;
            }
            .pull-right {
                float: right!important;
            }
        }
        @media(min-width:768px){
            .pull-right {
                float: left!important;
            }

        }

        .info-all { float: right!important;}
        #quite-c {color: #DC9125; float: right!important;}


        a{ color: #DC9125 }


        /*h4{ color: #DC9125 }*/

        .nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
            background-color: #ffffff;
            /*border-color: #DC9125;*/

            border-radius: 6px;
            border: solid 1px #DC9125;

            /*yello #DC9125*/
            /*gray #8C8C8E*/
        }
        .btn-primary:hover, .btn-primary:focus, .btn-primary:active, .btn-primary.active, .open .dropdown-toggle.btn-primary {
            color: #77171E;
            background-color: #ffffff;
            border-color: #DC9125;
        }

        .nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
            color: #DC9125
        }

        .btn, .btn-primary
        {
            color: #77171E;
            background-color: #ffffff;
            border-color: #DC9125;
        }
        .submit-btn { margin-top: 4%}

        li > a:hover {
            color: black;
        }
    </style>

</head>
<body>



    <div class="container">
        <div id="data-entry">




            <div class="row">
                <h4 class="title">Choose Direction</h4>
            </div>
            <div class="row">
                    <ul class="nav nav-pills direction pull-right">
                        <li ><a href="#">Northbound</a></li>
                        <li><a href="#">Southbound</a></li>
                    </ul>
            </div>
            <div class="row">
                <h4 class="title">Choose Day</h4>
            </div>
            <div class="row">
                    <ul class="nav nav-pills day pull-right">
                        <li ><a href="#">Weekday</a></li>
                        <li><a href="#">Saturday</a></li>
                        <li><a href="#">Sunday</a></li>
                    </ul>
            </div>




            <div id="user-data">

                <!--User Location selection-->
                <div class="row">
                    <h4 class="title" >Your Location:</h4>

                    <select class="form-control" id="from-stations">
                        <option>Choose direction first</option>
                    </select>

                </div>
                <!--Time selection-->
                <div class="row">

                    <h4 class="title">Time of Departure:</h4>

                    <select class="form-control" id="d-time">
                        <option>Choose your location</option>
                    </select>

                </div>
                <!--Destination selection-->
                <div class="row">
                    <h4 class="title">Destination:</h4>
                    <select class="form-control" id="to-stations">
                        <option>Choose direction first</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="entire-sch">
            <!--class="table-responsive"-->
            <div class="row">
                <h4 class="title">Your schedule</h4>
                <p id="quite-c"></p>
            </div>
            <table class="table table-striped">

                <thead>
                <tr>
                    <th>Time</th>
                    <th>Train</th>
                    <th>Station</th>
                </tr>
                </thead>

                <tbody id="schedule-table">
                <tr>
                    <td></td>
                    <td></td>
                    <td>row or cell</td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td>action</td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td>need attention</td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td>Indicates</td>
                </tr>
                </tbody>
            </table>
            <div class="row info-all">
                <h4 class="title" id="sch-info">Time</h4>
                <p>
                    <span class="glyphicon glyphicon-remove-circle"></span> Train arrives but does not continue
                    <br>
                    <span class="glyphicon glyphicon-ok-sign"></span> Service provided by RTD Bus

                </p>
            </div>
        </div>
        <div class="row submit-btn">
                <button type="button"
                        id="show-sch-btn"
                        class="btn btn-primary btn-lg pull-right">Show Schedule</button>
        </div>
    </div>


    <script type="text/javascript">



        // Station data from server
        var sData;
        var trainNum;
        var directionArray = [];


        // Helper to find unique stations
        var unique = function(origArr) {
            var newArr = [],
                    origLen = origArr.length,
                    found,
                    x, y;

            for ( x = 0; x < origLen; x++ ) {
                found = undefined;
                for ( y = 0; y < newArr.length; y++ ) {
                    if ( origArr[x] === newArr[y] ) {
                        found = true;
                        break;
                    }
                }
                if ( !found) newArr.push( origArr[x] );
            }
            return newArr;
        };
        // Helper to remove a given elem from array
        Array.prototype.removeByIndex = function(index) {
            this.splice(index, 1);
        };


        //call to get data from server with callback
        var ajax = {
            parseJSONP: function(result){
                sData = result;
            }
        };

        // get data from server and handle return
        $.ajax({
                    type       : "GET",
                    url        : "http://dev.appliciti.com/nmrx/config/work/json-all-schedules/",
                    dataType   : 'jsonp',
                    success    : function(response) {
                                    console.log("Data loaded successfully");
                                    ajax.parseJSONP(response);
                    },
                    error      : function() {
                        alert('Not working!');
                        console.log("Something went wrong trying to download data");
                    }
        });

        /*
        *
        * Highlight button based on user click
        * */
        $(document).ready(function () {
        var direction, day;
            $('ul.nav > li a').click(function (e) {
                // highlight option the user clicked
                $(this).closest('ul.nav').find('.active').removeClass('active');
                $(this).parent().addClass('active');

                // if the user clicked a Day option
                if($(this).text() == "Weekday" || $(this).text() == "Saturday" || $(this).text() == "Sunday" ){

                    //get the day that the user clicked
                    day = $(this).parent().text();


                }
                // the user clicked the direction
                else {
                    $('ul.day').find('.active').removeClass('active');
                    direction = $(this).parent().text();
                    $("#d-time").html("<select>Choose Day</select>");
                    $("#to-stations").html("<select>Choose Day</select>");
                    $("#from-stations").text('<select>Choose Day</select>');
                    day = ''
                }

                // console.log("The user choose: DAY: " + day +" DIRECTION: " + direction)


                setDirectionArray(direction, day);
                updateUserLocSelector();
            });
        });




        $('#from-stations').change(function () {
            //get the location of the user
            var userLocation = $(this).val();
            // check to make sure its valid
            if(userLocation != "Select" && userLocation != "Choose your location"){
                // save the position of the option selected
                var d = $(this)[0].selectedIndex;


                updateTimeSelector(userLocation);

            } else {
                // if not valid notify the user
                $('#d-time').html('<option>Choose your location</option>')
            }
        });

        $('#d-time').change(function(){
            // var index = $('#from-stations')[0].selectedIndex;
            var d = $('#from-stations').val();
            var t = $(this).val();
            updateUserDestSelector (d, t);
        });


        $('#show-sch-btn').click( function () {
            swExample();
            // if on schedule change to trip
            if ($(this).text() == "Show Schedule"){
                var sch = [];
                var userLoc = $('#from-stations').val();
                var userDes = $('#to-stations').val();
                var userTime = $('#d-time').val();


                //using the train number get the object
                for(var x =0; x < directionArray.length; x++){
                    if(directionArray[x]["train"] == trainNum){
                        sch.push(directionArray[x])
                    }
                }

                // remove trailing elements while its ont
                for(var i = sch.length - 1; i >= 0; i--) {
                    if(sch[i]["station"] != userDes) {
                        sch.removeByIndex(i);
                    } else if (sch[i]["station"] == userDes){
                        break;
                    }

                }

                // removing zero element while not the user's location
                while(sch[0]["station"] != userLoc){
                    sch.removeByIndex(0);
                }

                var t1 = new Date();
                var t2 = new Date();

                // setting time
                var pt = sch[sch.length-1]["time"].match(/(\d+)(?::(\d\d))?\s*(p?)/);
                t1.setHours( parseInt(pt[1]) + (pt[3] ? 12 : 0) );
                t1.setMinutes( parseInt(pt[2]) || 0 );

                // setting time time 2
                var pt2 = sch[0]["time"].match(/(\d+)(?::(\d\d))?\s*(p?)/);
                t2.setHours( parseInt(pt2[1]) + (pt2[3] ? 12 : 0) );
                t2.setMinutes( parseInt(pt2[2]) || 0 );

                // estimate time
                var ms = t1 - t2;
                x = ms / 1000;
                // var seconds = x % 60;
                x /= 60;
                // var minutes = x % 60;
                x /= 60;
                var hours = x % 24;

                // truncate decimal
                var trunHours = Math.floor(hours * 10) / 10;
                // DEBUG
                // console.log( hours );

                var schl = "";
                for (var c =0; c < sch.length; c++){
                    var busAvil = (sch[c]["rtd"]=="1")?'<span class="glyphicon glyphicon-ok-sign"></span>':'';
                    var lastTrain = (sch[c]["final"]=="1")?'<span class="glyphicon glyphicon-remove-circle"></span>':'';
                    schl += '<tr>' +
                                '<td>'+ sch[c]["time"] +'</td>' +
                                '<td>'+ sch[c]["train"] +'</td>' +
                                '<td>'+ sch[c]["station"] + " " + busAvil + " " + lastTrain +'</td>'+
                            '</tr>';
                }
                // these are the trains that have quiet cars
                if(sch[0]["train"] == "502" || sch[0]["train"] == "504" ||
                        sch[0]["train"] == "102_exp" || sch[0]["train"] == "506" ||
                        sch[0]["train"] == "512" || sch[0]["train"] == "514" ||
                        sch[0]["train"] == "503" || sch[0]["train"] == "507" ||
                        sch[0]["train"] == "509" || sch[0]["train"] == "515" ||
                        sch[0]["train"] == "101_exp" || sch[0]["train"] == "517" ||
                        sch[0]["train"] == "519"){
                    // show user
                    $("#quite-c").text("Designated QUIET CAR available");
                }

                // display schedule to user
                document.getElementById("schedule-table").innerHTML = schl;
                // total time
                $("#sch-info").text("Total Time (est.): " + trunHours + "hours");



                // adjust views
                $(this).fadeOut();
                $(this).text("Change Trip");
                $("#data-entry").fadeOut();
                $("#entire-sch").delay(500).fadeIn();
                $(this).delay(100).fadeIn();

            }
            // if on trip change to schedule
            else {
                // set the text of the button

                // adjust views
                $("#entire-sch").fadeOut();
                $(this).fadeOut();
                $("#data-entry").delay(500).fadeIn();
                $(this).text("Show Schedule");
                $(this).delay(100).fadeIn();


            }
        });

        // this sets an array that holds all the object associated with direction "Northbound Weekday"
        function setDirectionArray(dir, day){
            var dirday = dir + " " + day;

            for(var x =0; x < sData.length; x++){
                if (sData[x]["name"] == dirday){
                    directionArray  = sData[x]["data"]
                }
            }

        }

        function updateUserLocSelector(){

            var stations = []
            //getting all the unique station names
            for(var x =0; x < directionArray.length; x++){
                if(stations.indexOf(directionArray[x]["station"]) == -1){
                    stations.push(directionArray[x]["station"])
                }
            }

            /*
            *
            * Set FROM options
            *
            * */
            var stringFrom = '<option>Select</option>';
            for (var s = 0; s < stations.length; s++){
                stringFrom += '<option>'+ stations[s] +'</option>';
            }
            document.getElementById("from-stations").innerHTML = stringFrom;
        }

        function updateUserDestSelector (from, time){
            // get unique stations
            var stops = [];

            // find the train number associated with time and location
            for(var x =0; x < directionArray.length; x++){
                if(directionArray[x]["station"] == from && directionArray[x]["time"] == time){
                    trainNum =  directionArray[x]["train"];
                    break;
                }
            }

            // get all the stops of that train
            for(var x =0; x < directionArray.length; x++){
                //console.log(directionArray[x]["train"] );
                if(directionArray[x]["train"].indexOf(trainNum) > -1){
                    stops.push(directionArray[x]);
                }
            }

            // removing zero element while not the user's location
            while(stops[0]["station"] != from){
                stops.removeByIndex(0);
            }
            // also remove the object that is the same as the user location
            stops.removeByIndex(0);

            /*
             *
             * Set TO options
             *
             *
             * */
            var stringTo = '';

             if(stops.length > 0){
                stringTo = '<option>Select</option>';
                // from is the option selected
                // since we dont want to include options prior we start from what the user selected
                for (var s = 0; s < stops.length; s++){
                    stringTo += '<option>'+ stops[s]["station"] +'</option>';
                }
            } else{
                stringTo = '<option>Train arrives but does not continue</option>'
            }

            document.getElementById("to-stations").innerHTML = stringTo;
        }

        function updateTimeSelector(userStation) {

            // get times from given station
            var times = [];
            //getting all the unique station names
            for(var x =0; x < directionArray.length; x++){
                if(directionArray[x]["station"].indexOf(userStation) > -1){
                    times.push(directionArray[x]["time"])
                }
            }

            /*
             *
             * Set TIME options
             *
             * */
            var stringTimes = '<option>Select</option>';
            for (var s = 0; s < times.length; s++){
                stringTimes += '<option>'+ times[s] +'</option>';
            }
            document.getElementById("d-time").innerHTML = stringTimes;
        }


        function swExample() {
            var numbers = { 0: 0, 1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 6, 7: 7, 8: 8, 9: 9 };
            SpinningWheel.addSlot(numbers, 'right');
            SpinningWheel.addSlot(numbers, 'right');
            SpinningWheel.addSlot({ separator: '.' }, 'readonly shrink');
            SpinningWheel.addSlot(numbers, 'right');
            SpinningWheel.addSlot({ Kg: 'Kg', Lb: 'Lb', St: 'St' }, 'shrink');

            SpinningWheel.setCancelAction(cancel);
            SpinningWheel.setDoneAction(done);

            SpinningWheel.open();
        }

        function done() {
            var results = SpinningWheel.getSelectedValues();
            alert('values:' + results.values.join(', ') + ' - keys: ' + results.keys.join(', '));
        }

        function cancel() {
            alert('cancelled!');
        }

    </script>

</body>
</html>